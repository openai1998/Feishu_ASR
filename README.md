# 多线程上传/下载飞书妙记（SRT字幕）

## 使用场景

- 定期下载飞书会议视频与字幕，实现会议的自动备份。
- 定期检查统一存储空间使用情况，快要超出则删除旧的妙记。
- 从本地批量上传视频后导出字幕，实现语音转文字。

## 使用步骤

### 1. 安装依赖

首先安装`requirements.txt`中的库。

```bash
pip install -r requirements.txt
```

### 2. 获取Cookie

打开[飞书妙记主页](https://meetings.feishu.cn/minutes/home)，按F12打开开发者工具，点击`网络`栏，刷新后复制网络请求 *list?size=20&space_name=* 中的`cookie`，粘贴至`config.ini`的`minutes_cookie`。

### 3. （可选）获取管理Cookie

在[飞书管理后台](https://home.feishu.cn/admin/index)按F12，刷新后复制网络请求 *count?_t=* 中的`cookie`，粘贴至`config.ini`的`manager_cookie`。这一步是为了在存储空间不足时进行删除操作。

### 4. 配置参数

根据自身需求修改`config.ini`中的参数，包括下载设置、字幕格式、保存路径等。

### 5. 下载妙记

执行以下命令以下载妙记：

```bash
python feishu_downloader_v1.1.py
```

该程序支持批量下载会议记录，包括视频和字幕文件。

### 6. 上传妙记

将要上传的视频路径填写到`config.ini`中，然后执行以下命令：

```bash
python feishu_uploader_v1.4.py
```

该程序支持批量上传视频文件，并自动生成字幕。

## 功能说明

### 下载功能

- **获取妙记信息**：定期检查并下载新的妙记，包括视频和字幕。
- **字幕下载**：支持下载字幕文件，格式可选择SRT或TXT。
- **存储管理**：在存储空间不足时自动删除旧的妙记以释放空间。
- **多线程下载**：使用`aria2`进行多线程下载，提高下载速度。
- **下载记录**：记录已下载的妙记，避免重复下载。

### 上传功能

- **视频上传**：支持将本地视频文件批量上传至飞书，并自动生成字幕。
- **进度显示**：在上传过程中显示进度条，便于用户了解上传状态。
- **去重验证**：通过计算文件的MD5哈希值，避免重复上传。支持本地和云端去重验证。
- **日志记录**：记录上传日志，包括视频名称、原始文件名、哈希值、上传日期和URL。
- **每日上传限制**：设置每日上传限制，避免超出API调用频率。

## 详细功能说明

### feishu_downloader_v1.1.py

- **配置文件读取**：从`config.ini`中读取下载设置、字幕格式、保存路径等参数。
- **获取妙记信息**：通过API获取妙记列表，并根据配置文件中的设置进行过滤。
- **下载妙记**：使用`aria2`进行多线程下载，支持视频和字幕文件的下载。
- **存储管理**：在存储空间不足时，自动删除旧的妙记以释放空间。
- **日志记录**：记录已下载的妙记，避免重复下载。

### feishu_uploader_v1.4.py

- **配置文件读取**：从`config.ini`中读取上传设置、代理设置等参数。
- **获取云端视频列表**：通过API获取云端已有的视频列表，避免重复上传。
- **计算文件哈希值**：通过计算文件的MD5哈希值，进行本地去重验证。
- **上传视频**：支持批量上传视频文件，并自动生成字幕。使用多线程进行分块上传，提高上传速度。
- **进度显示**：在上传过程中显示进度条，便于用户了解上传状态。
- **日志记录**：记录上传日志，包括视频名称、原始文件名、哈希值、上传日期和URL。支持Excel格式的日志记录。
- **每日上传限制**：设置每日上传限制，避免超出API调用频率。

## 注意事项

- 下载需要用到`aria2`，本仓库中给出的是win64版本的，如果你是其他操作系统请在 [aria2 Releases](https://github.com/aria2/aria2/releases) 中下载相应版本并替换。
- `minutes_cookie`是以 *minutes_csrf_token=* 为开头的很长的一个字符串。
- `manager_cookie`是以 *__tea__ug__uid==* 为开头的很长的一个字符串。
- [飞书分片上传文件API](https://open.feishu.cn/document/server-docs/docs/drive-v1/upload/multipart-upload-file-/introduction) 中声明该接口不支持太高的并发且调用频率上限为5QPS，且本人无批量转文字需求，故未对多个文件的同时转写进行尝试。本项目仅为实现上传与下载的自动化。

## 免责声明

本项目仅供学习和研究使用，使用过程中请遵循相关法律法规。对于因使用本项目而导致的任何直接或间接损失，作者不承担任何责任。

## 贡献

欢迎提交问题和建议，或直接提交PR以改进本项目。

请根据需要进行调整或补充！如果有其他问题，请告诉我！


请根据需要进行调整或补充！如果有其他问题，请告诉我！

项目参考[feishu_minutes](https://github.com/xuejianxianzun/feishu-minutes-auto-backup)感谢大佬的开源。